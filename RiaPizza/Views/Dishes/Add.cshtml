@{
    ViewData["Title"] = "Add";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
@section css{
    <link href="~/assets/js/Trumbowyg-master/dist/ui/trumbowyg.css" rel="stylesheet" />
    <style>
        .null-marbottom {
            margin-bottom: 0 !important;
        }

        .right {
            float: right;
        }

        .hide{
            display:none;
        }
    </style>
}
@*<script src="~/Angular/Controllers/DishCtrl.js"></script>*@
<script>

    App.controller("DishesCtrl", function ($scope, $http) {

        function JsonCallParam(Controller, Action, Parameters) {
            $.ajax({
                type: "POST",
                traditional: true,
                async: false,
                cache: false,
                url: '/' + Controller + '/' + Action,
                context: document.body,
                data: Parameters,
                success: function (json) {
                    list = null;
                    list = json;
                }
                ,
                error: function (xhr) {
                    list = null;
                }
            });
        }
        function JsonCall(Controller, Action) {
            $.ajax({
                type: "POST",
                traditional: true,
                async: false,
                cache: false,
                url: '/' + Controller + '/' + Action,
                context: document.body,
                success: function (json) {
                    list = null; list = json;
                },
                error: function (xhr) {
                    list = null;
                    //debugger;
                }
            });
        }

        $scope.allDishes = [];
        $scope.viewDishExtraType = [];
        $scope.viewDishExtras = [];
        $scope.dishCategories = [];
        $scope.multipleSizes = false;
        $scope.dishSizes = [];
        $scope.sizeToppingPrices = [];
        $scope.haveToppings = false;


        //Add Dish Objects
        $scope.addDish = { dishName: '', subName: '', description: '', dishCategoryId: '0', basePrice: 0, allergies: '', dishSizes: [] };
        $scope.addDishExtraTypes = [];

        $scope.getDishCategories = function () {
            JsonCall("DishCategories", "GetAllCategories");
            if (list !== null) {
                $scope.dishCategories = list;
                $scope.addDish.dishCategoryId = 0;
            }
        }


        //Start Dish Only Function
        $scope.saveDish = function () {
            if ($scope.addDish.dishName === "" || Number($scope.addDish.dishCategoryId) === 0 || $scope.addDish.basePrice === 0) {
                $('#validation').show();
                return;
            } else $('#validation').hide()


            if ($scope.haveToppings) {
                for (var i = 0; i < $scope.addDishExtraTypes.length; i++) {
                    if ($scope.addDishExtraTypes[i].typeName === "") { $('#validation').show(); return; } else $('#validation').hide()
                    for (var j = 0; j < $scope.addDishExtraTypes[i].dishExtras.length; j++) {
                        if ($scope.addDishExtraTypes[i].dishExtras[j].extraName === "") {
                            $('#validation').show();
                            return;
                        } else $('#validation').hide()
                    }
                }
            }

            if ($scope.multipleSizes) {
                $scope.addDish.dishSizes = $scope.dishSizes;
            }

            var comment = CKEDITOR.instances.editor1.getData();
            var commentt = CKEDITOR.instances.editor2.getData();
            // $scope.addDish.allergies = document.getElementById("editor1").value;

            $scope.addDish.allergies = CKEDITOR.instances.editor1.getData();
            $scope.addDish.description = CKEDITOR.instances.editor2.getData();
            var pram = { "dish": JSON.stringify($scope.addDish), "dishExtraTypes": JSON.stringify($scope.addDishExtraTypes) };
            JsonCallParam("Dishes", "CreateDish", pram);
            if (list === "Success") {
                $("#addModal").modal("hide");
                swal("Added", "Dish Added!", "success");

                $scope.addDish = { dishName: '', subName: '', description: '', dishCategoryId: 0, basePrice: 0 };
                CKEDITOR.instances.editor1.value = '';
                CKEDITOR.instances.editor2.value = '';
                $scope.addDishExtraTypes = [];
                $scope.dishSizes = [];
                $scope.multipleSizes = false;
            }
        }
        $scope.saveDishExtraType = function () {
            for (var i = 0; i < $scope.addDishExtraTypes.length; i++) {
                if ($scope.addDishExtraTypes[i].typeName === "") { return; }
                for (var j = 0; j < $scope.addDishExtraTypes[i].dishExtras.length; j++) { if ($scope.addDishExtraTypes[i].dishExtras[j].extraName === "") { return; } }
            }

            var pram = { "dishId": JSON.stringify(document.getElementById('dishId').value), "dishExtraTypes": JSON.stringify($scope.addDishExtraTypes) };
            JsonCallParam("Dishes", "AddDishExtras", pram);
            if (list === "Success") {
                $("#addDishExtra").modal("hide");
                swal("Added", "Dish Topping Added!", "success");

                $scope.addDishExtraTypes = [];
                location.reload();
            }
        }
        $scope.pushDishExtraType = function () {
            var length = $scope.addDishExtraTypes.length;
            if (length === 0) {
                let list = [];
                for (var i = 0; i < $scope.sizeToppingPrices.length; i++) {
                    list.push({ dishExtraId: 0, dishSizeId: 0, price: 0, sizeName: $scope.sizeToppingPrices[i].sizeName });
                }
                $scope.addDishExtraTypes.push({ typeName: '', chooseMultiple: true, dishExtras: [{ extraName: '', extraPrice: 0, sizeToppingPrices: list }] });
            }
            else if ($scope.addDishExtraTypes[length - 1].typeName !== '') {
                let list = [];
                for (var i = 0; i < $scope.sizeToppingPrices.length; i++) {
                    list.push({ dishExtraId: 0, dishSizeId: 0, price: 0, sizeName: $scope.sizeToppingPrices[i].sizeName });
                }
                $scope.addDishExtraTypes.push({ typeName: '', chooseMultiple: true, dishExtras: [{ extraName: '', extraPrice: 0, sizeToppingPrices: list }] });
            }
        }
        $scope.pushDishExtra = function (i) {
            var length = $scope.addDishExtraTypes[i].dishExtras.length;
            if (length === 0) {
                let list = [];
                for (var j = 0; j < $scope.sizeToppingPrices.length; j++) {
                    list.push({ dishExtraId: 0, dishSizeId: 0, price: 0, sizeName: $scope.sizeToppingPrices[j].sizeName });
                }
                $scope.addDishExtraTypes[i].dishExtras.push({ extraName: '', extraPrice: 0, sizeToppingPrices: list });
            }
            else if ($scope.addDishExtraTypes[i].dishExtras[length - 1].extraName !== "") {
                let list = [];
                for (var j = 0; j < $scope.sizeToppingPrices.length; j++) {
                    list.push({ dishExtraId: 0, dishSizeId: 0, price: 0, sizeName: $scope.sizeToppingPrices[j].sizeName });
                }
                $scope.addDishExtraTypes[i].dishExtras.push({ extraName: '', extraPrice: 0, sizeToppingPrices: list });
            }
        }
        $scope.removeExtraType = function (i) {
            $scope.addDishExtraTypes.splice(i, 1);
        }
        $scope.removeExtra = function (extratype, i) {
            $scope.addDishExtraTypes[extratype].dishExtras.splice(i, 1);
        }
        $scope.addSize = function () {
            var count = $scope.dishSizes.length;
            if (count !== 0) {
                if ($scope.dishSizes[count - 1].size == "") return;
                else {
                    $scope.dishSizes.push({ size: "", basePrice: 0.0, diameter: "" });
                    $scope.sizeToppingPrices.push({ dishExtraId: 0, dishSizeId: 0, price: 0, sizeName: "" });
                }
            }
            else {
                $scope.dishSizes.push({ size: "", basePrice: 0.0, diameter: "" });
                $scope.sizeToppingPrices.push({ dishExtraId: 0, dishSizeId: 0, price: 0, sizeName: "" });
            }
        }
        $scope.removeSize = function (index) {
            $scope.dishSizes.splice(index, 1);
            $scope.sizeToppingPrices.splice(index, 1);
        }
        //End Dish Only Function

        //Start UI Functions
        $scope.openDishEditModal = function (dish) {
            $scope.editDish = { dishId: dish.dishId, dishName: dish.dishName, subName: dish.subName, allergies: dish.allergies, description: dish.description, dishCategoryId: dish.dishCategoryId, basePrice: dish.basePrice };
            $("#editDishModal").modal();
        }
        $scope.openDishExtraTypeEditModal = function (dishExtraType) {
            $scope.editDishExtraType = { dishExtraTypeId: dishExtraType.dishExtraTypeId, typeName: dishExtraType.typeName, dishId: dishExtraType.dishId, chooseMultiple: dishExtraType.chooseMultiple };
            $("#editDishModal").modal();
        }
        $scope.openDishExtraEditModal = function (dishextra) {
            $scope.editDishExtra = { dishExtraId: dishextra.dishExtraId, extraName: dishextra.extraName, dishExtraTypeId: dishextra.dishExtraTypeId, extraPrice: dishextra.extraPrice };
            $("#editDishExtraModal").modal();
        }
        //End UI Functions
        $scope.delDishCategory = function (cat) {
            $scope.delDishCategoryObj = { dishCategoryId: cat.dishCategoryId };
            var pram = { "dishCategory": JSON.stringify($scope.delDishCategoryObj) };
            JsonCallParam("DishCategories", "Delete", pram);
            if (list == "Success") {
                $scope.getAllCategories();
                swal("Removed", "Dish Category Deleted!", "success");
            }
        }
        $scope.proceed = function () {
            $scope.addDishExtraTypes = [];
            $scope.pushDishExtraType();
        }
        
    });

</script>
<div class="container-fluid" ng-controller="DishesCtrl">
    <div class="block-header">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="breadcrumb breadcrumb-style ">
                    <li class="breadcrumb-item">
                        <h4 class="page-title">Dishes</h4>
                    </li>
                    <li class="breadcrumb-item bcrumb-1">
                        <a href="~/Home/Index">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                    <li class="breadcrumb-item bcrumb-2">
                        <a href="#" onClick="return false;">Dishes</a>
                    </li>
                    <li class="breadcrumb-item active">Add</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row clearfix">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            <div class="card">
                <div class="header">
                    <h2>
                        <strong>Add</strong> Dish
                    </h2>
                </div>
                <div class="body formBody">
                    <h2 class="card-inside-title">Dish Details</h2>
                    <div class="row clearfix">
                        <div class="col-lg-12 col-md-12 null-marbottom">
                            <label>Dish Category <span class="text-danger">*</span></label>
                            <div class="form-group" ng-init="getDishCategories()">
                                <select class="form-control" ng-model="addDish.dishCategoryId" required>
                                    <option value="0" hidden>Select Category</option>
                                    <option ng-repeat="cat in dishCategories" value="{{cat.dishCategoryId}}">{{cat.categoryName}}</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-12 null-marbottom">
                            <div class="form-group">
                                <label>Dish Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" placeholder="Enter Dish Name" ng-model="addDish.dishName" required>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-12 null-marbottom">
                            <div class="form-group">
                                <label>Sub Name</label>
                                <input type="text" class="form-control" placeholder="Enter Dish Sub Name" ng-model="addDish.subName">
                            </div>
                        </div>
                        <div class="col-lg-12 col-md-12 null-marbottom">
                            <div class="form-group">
                                <label>Base Price <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" placeholder="$$" ng-model="addDish.basePrice"  required>
                            </div>
                        </div>
                        <div class="col-lg-12 col-md-12 null-marbottom">
                            <div class="form-group">

                                <label>Allergies <span class="text-danger">*</span></label>
                                <textarea id="editor1" name="editor1" required>
                                </textarea>

                            </div>
                        </div>
                        <div class="col-md-12 col-md-12">
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="editor2" name="editor2" required>
                                </textarea>
                            </div>
                        </div>
                        <div class="col-md-12 col-md-12">
                            <div class="form-group" style="width:100%;">
                                <label style="width:10%; float:left">Multiple Sizes</label>
                                <div class="switch" style="width:90%; float:right">
                                    <label>
                                        <input type="checkbox" ng-model="multipleSizes">
                                        <span class="lever switch-col-light-blue"></span>
                                    </label>
                                </div>
                            </div>
                            <form name="sizeForm" ng-if="multipleSizes" id="sizeForm">
                                <table>
                                    <tr>
                                        <th width="30%">Size</th>
                                        <th width="30%">Price</th>
                                        <th width="30%">Diameter</th>
                                        <th width="10%" style="text-align:right">
                                            <button class="btn btn-primary" ng-disabled="haveToppings" ng-click="addSize()"><i class="fa fa-plus"></i></button>
                                        </th>
                                    </tr>
                                    <tr ng-repeat="size in dishSizes">
                                        <td>
                                            <div class="form-group">
                                                <input type="text" class="form-control" ng-change="sizeToppingPrices[$index].sizeName = size.size" name="size" ng-model="size.size" />
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-group">
                                                <input type="number" min="0" class="form-control" name="sizebaseprice" ng-model="size.basePrice" />
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-group">
                                                <input type="text" class="form-control" name="diameter" ng-model="size.diameter" />
                                            </div>
                                        </td>
                                        <td style="text-align:right">
                                            <button class="btn btn-danger" ng-disabled="haveToppings" ng-click="removeSize($index)"><i class="fas fa-trash-alt"></i></button>
                                        </td>
                                    </tr>
                                </table>
                            </form>
                        </div>
                        <div class="col-md-12 col-md-12">
                            <div class="form-group" style="width:100%;">
                                <label style="width:10%; float:left">Dish Toppings</label>
                                <div class="switch" style="width:80%;">
                                    <label>
                                        <input type="checkbox" ng-click="proceed()" ng-model="haveToppings">
                                        <span class="lever switch-col-light-blue"></span>
                                    </label>
                                </div>
                                <button type="button" class="btn btn-primary" style="width:5%; float:right; margin-top:-30px" ng-click="pushDishExtraType()" ng-disabled="!haveToppings">
                                    <i class="fa fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div ng-if="haveToppings">
                        <div class="row clearfix" ng-repeat="extraType in addDishExtraTypes" ng-init="extraTypeIndex=$index">
                            <div class="col-lg-10 null-marbottom">
                                <div class="form-group null-marbottom">
                                    <div class="form-line">
                                        <label>Topping Category Head <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" placeholder="Enter Topping Name" ng-model="extraType.typeName">
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-1">
                                <div class="form-group null-marbottom right">
                                    <div class="form-line">
                                        <label>Allow Multiple <span class="text-danger">*</span></label>
                                        <div class="switch">
                                            <label>
                                                <input type="checkbox" ng-model="extraType.chooseMultiple">
                                                <span class="lever switch-col-light-blue"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-1">
                                <div class="form-group null-marbottom right">
                                    <div class="form-line">
                                        <label>Actions</label><br />
                                        <button class="btn btn-danger" ng-click="removeExtraType($index)"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-1"></div>
                            <div class="col-lg-10">
                                <span style="font-weight:bold">Dish Toppings</span>
                                <button ng-click="pushDishExtra($index)" type="button" class="btn bg-orange btn-circle waves-effect waves-circle waves-float right">
                                    <i class="fa fa-plus"></i>
                                </button>
                                <div class="row clearfix" ng-if="extraType.dishExtras.length > 0" style="margin-top:30px">
                                    <div class="col-lg-12">
                                        <div class="row">
                                            <div class="col-lg-3 null-marbottom"><label>Topping Name <span class="text-danger">*</span></label></div>
                                            <div class="col-lg-3 null-marbottom"><label>Allergies</label></div>
                                            <div class="col-lg-3 null-marbottom" ng-if="!multipleSizes"><label>Topping Price</label></div>
                                            <div class="col-lg-2 null-marbottom"><label class="right">Actions</label></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row clearfix" ng-repeat="extra in extraType.dishExtras" ng-init="extraIndex=$index">
                                    <div class="col-lg-12">
                                        <div class="row">
                                            <div class="col-lg-3 null-marbottom">
                                                <div class="form-group">
                                                    <input type="text" class="form-control" placeholder="Topping" ng-model="extra.extraName" required>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 null-marbottom">
                                                <div class="form-group">
                                                    <input type="text" class="form-control" placeholder="Allergies" ng-model="extra.allergies" />
                                                </div>
                                            </div>
                                            <div class="col-lg-3 null-marbottom" ng-if="!multipleSizes">
                                                <input type="number" class="form-control" placeholder="$$" ng-model="extra.extraPrice" required>
                                            </div>
                                            <div class="col-lg-2 null-marbottom">
                                                <button class="btn btn-danger right" ng-click="removeExtra(extraTypeIndex, extraIndex)"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-12" ng-if="multipleSizes" style="margin-top:-20px">
                                        <div class="row">
                                            <div class="col-lg-3" ng-repeat="sizePrice in extra.sizeToppingPrices">
                                                <div class="form-group">
                                                    <label>{{sizePrice.sizeName}}</label>
                                                    <input type="number" min="0" class="form-control" placeholder="{{sizePrice.sizeName}}" ng-model="sizePrice.price" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-1"></div>
                        </div>
                    </div>

                    <p class="text-danger" style="display:none" id="validation">Please fill all required data</p>

                    <button class="btn btn-info" style="float:right; margin-right:5px">Clear</button>
                    <button ng-click="saveDish()" class="btn btn-success" style="float:right;">Save</button>
                </div>
            </div>
        </div>
    </div>

</div>

@section scripts{


    <script src="~/assets/js/form.min.js"></script>
    <script src="~/assets/js/pages/forms/form-wizard.js"></script>

    <script src="https://cdn.ckeditor.com/4.14.0/standard/ckeditor.js"></script>
    <script>
        CKEDITOR.replace('editor1');
        CKEDITOR.replace('editor2');
        CKEDITOR.config.height = 150;

    </script>


}